<script>
  function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  $(document).ready(function() {
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/total_number_of_community_school', function(data) {      
      $('#community-school').html(numberWithCommas(data));
			console.log(numberWithCommas(data));
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/total_no_of_schools_with_toilet_facilities', function(data) {      
      $('#toilet-facilities').html(numberWithCommas(data));
      $('#schools-with-toilet-value').html('(' + numberWithCommas(data) + ')');      
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/percentage_of_schools_with_toilet_facilities', function(data) {      
      $('#schools-with-toilet-percent').html(data + '%');
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/total_no_of_toilets_for_girl_students_with_items_facilities', function(data) {      
      $('#separate-toilets-for-girls').html('(' + numberWithCommas(data) + ')');
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/percentage_of_separate_toilets_for_girls_with_items_facilities', function(data) {      
      $('#separate-toilets-for-girls-percent').html(data + '%');
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/total_students_boys_and_girls', function(data) {      
      $('#total-students').html(numberWithCommas(data));
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/percentage_of_schools_with_separate_toilets_for_girls', function(data) {      
      $('#schools-with-separate-toilets-for-girls-percent').html(data + '%');
    });
    
    $.getJSON('http://localhost:3000/api/v1/school_sanitation/total_no_districts', function(data) {      
      $('#tdistricts').html(numberWithCommas(data));
    });		
  });
</script>

<script type="text/javascript">
	google.load("visualization", "1", {packages:["corechart"]});
	google.setOnLoadCallback(drawChart);
	
	function drawChart() {
		drawToiletFacilitiesChart();
		drawToiletForGirlsChart();
		drawSeparateToiletForGirlsChart();
	}
	
	function drawToiletFacilitiesChart() {
		$.getJSON('http://localhost:3000/api/v1/school_sanitation/percentage_of_schools_with_toilet_facilities', function(data) {
			var vdata = google.visualization.arrayToDataTable([
				['Toilet', 'Percent'],
				['School with Toilet', data],
				['School without Toilet', (100-data)]
			]);
      
			var chart = new google.visualization.PieChart(document.getElementById('chart-schools-with-toilet-percent'));
			chart.draw(vdata);
		});
	}
	
 	function drawToiletForGirlsChart() {
		$.getJSON('http://localhost:3000/api/v1/school_sanitation/percentage_of_separate_toilets_for_girls_with_items_facilities', function(data) {
			var vdata = google.visualization.arrayToDataTable([
				['Toilet For Girls', 'Percent'],
				['School Toilet for Girls', data],
				['School without Toilet for Girls', (100-data)]
			]);
      
			var chart = new google.visualization.PieChart(document.getElementById('chart-separate-toilets-for-girls'));
			chart.draw(vdata);
		});
	}

	function drawSeparateToiletForGirlsChart() {
		$.getJSON('http://localhost:3000/api/v1/school_sanitation/percentage_of_schools_with_separate_toilets_for_girls', function(data) {
			var vdata = google.visualization.arrayToDataTable([
				['Toilet', 'Percent'],
				['Separate Toilet', data],
				['Without Separate Toilet', (100-data)]
			]);
      
			var chart = new google.visualization.PieChart(document.getElementById('schools-with-separate-toilets-for-girls'));
			chart.draw(vdata);
		});
	}
</script>

<div id="top">
	<div id="top-inner"></div>
</div>

<div id="header"><!--header-->
	<div class="main">
		
		<div id="title">
			<h1><strong>The state of school sanitation in Nepal</strong></h1>
			<p>The neglected development link.</p>
		</div>
		
		<div id="display-map">Display Map</div>
		<div id="overall"><p>Overall</p></div>
		<div id="goto"><a href="#map"><p>Goto Map</p></a></div>
		<div class="clear"></div>
	</div>
</div><!--/header-->
	
<div id="nav"><!--nav-->
	<div class="main">
		
		<div id="school">
			<div id="community-school" class="total"></div>
			<div class="section">Community School</div>
		</div>
		
		<div id="toilet">
			<div id="toilet-facilities" class="total"></div>
			<div class="section">Toilet Facilities</div>
		</div>
		
		<div id="students">
			<div id="total-students" class="total"></div>
			<div class="section">Students</div>
		</div>

		<div class="clear"></div>
	</div>
</div><!--/nav-->
		
<div id="schools-toilet-top"></div><!--schools toilet-->

<div id="schools-toilet">
	<div class="main">
		<div class="page">
			
			<div class="left">
				<h2>No. of Schools with Toilet</h2>
				<hr>
				<div id="chart-schools-with-toilet-percent" style="width: 450px; height: 300px;"></div>
				<div class="text">
					<div id="schools-with-toilet-percent" class="percent"></div>
					<div id="schools-with-toilet-value" class="value"></div>
					<div class="name">Schools with Toilet</div>
				</div>
			</div>
		
			<div class="right">
				<div class="image">Toilet</div>
			</div>

			<div class="clear"></div>
			<div class="top-button"><a href="#">Top</a></div>
		</div>
	</div>
</div><!--schools toilet-->

<div id="girls-toilet"><!--girls toilet-->
	<div class="main">
		<div class="page">
			
			<div class="left">
				<h2>No. of Separate Toilets for Girls</h2>
				<hr>
				<div id="chart-separate-toilets-for-girls" style="width: 450px; height: 300px;"></div>
				<div class="text">
					<div id="separate-toilets-for-girls-percent" class="percent"></div>
					<div id="separate-toilets-for-girls" class="value"></div>
					<div class="name">Separate Toilets for Girls</div>
				</div>
			</div>
			
			<div class="right">
				<div class="image">Girls Toilet</div>
			</div>
			
			<div class="clear"></div>
			<div class="top-button"><a href="#">Top</a></div>
		</div>
	</div>
</div><!--/girls toilet-->

<div id="separate-girls-toilet"><!--separate girls toilet-->
	<div class="main">
		<div class="page">

			<div class="left">
				<h2>No. of Schools with separate Toilets for Girls</h2>
				<hr>
				<div id="schools-with-separate-toilets-for-girls" style="width: 450px; height: 300px;"></div>
				<div class="text">
					<div id="schools-with-separate-toilets-for-girls-percent" class="percent"></div>
					<div class="name">Schools with separate Toilets for Girls</div>
				</div>
			</div>

			<div class="right">
				<div class="image">Separate Girls Toilet</div>
			</div>

			<div class="clear"></div>
			<div class="top-button"><a href="#">Top</a></div>
			<div id="average-top"></div>
		</div>
	</div>
</div><!--/separate girls toilet-->

<!--average-->
<div id="average">
	<div class="main">
		<div class="page">
			<h3>On Average,</h3>
			<div id="first-ratio" class="toilet-quantity">1</div>
			<div class="average-toilet">Toilet</div>
			<div class="serves">serves</div>
			<div id="second-ratio" class="students-numbers">127</div>
			<div class="average-students">Students</div>
		</div>
		<div class="clear"></div>
		<div id="map-top"></div>
	</div>
</div><!--/average-->

<!--map-->
<div id="map"></div>
<!--/map-->

<script>
	var global_url = "";
	function MapUrl(data){
    var url = data;
   
    this.getUrl = function(){
        return url;
    };
   
    this.setUrl = function(data){
        url = data;
    };
	}
  var data_location = "http://localhost:3000/api/v1/school_sanitation/search?utf8=%E2%9C%93&district=";
	var NepalMap = function(options) {
		var self = this, map = null, options = options;

		this.init = function() {
			map = new L.Map(options.mapcontrol_id, {
				dragging: false, 
				zoomControl: false, 
				scrollWheelZoom: false, 
				doubleClickZoom: false, 
				touchZoom: false, 
				trackResize: false, 
				attributionControl: false
				});			
			map.setView(new L.LatLng(28.40, 84.15), 7);
			self.initMap();

		};

		this.addDistrict = function(district_layer) {
			self.map.addLayer(district_layer.get())
		};

		this.initMap = function() {	
			var geojsonLayer = [];
			for(var i=0;i<75;i++) {
				geojsonLayer[i] = new DistrictLayer({geojsonObject: options.districts[i], name:"DIST_NAME"});
				map.addLayer(geojsonLayer[i].get());
			}
		};
	};

	var DistrictCollection = function() {
		var self = this,
			districts = null;

		this.init = function(districts_objects) {
			self.districts = [];
			for(var i=0;i<75;i++) {
				self.districts.push(new DistrictLayer({geojsonObject:districts_objects[i], name:"DIST_NAME"}));
			}
		};

		this.getArray = function() {
			return self.districts;
		};

		this.get = function(index) {
			return self.districts(index);
		};
	};
	
	var DistrictLayer = function(options) {
		var self = this,
			options = options,			
			name = null;

		this.set = function(GeoJSONObject) {
			self.geojsonLayer = new L.GeoJSON();	
			self.geojsonLayer.on('featureparse', self.parse);
			self.geojsonLayer.on('click', self.click);
			self.geojsonLayer.on('mouseover', function(e) {
				e.layer.setStyle({fillColor:"red"})
			});
			self.geojsonLayer.on('mouseout', function(e) {
				e.layer.setStyle({fillColor:"blue"})
			});
			self.geojsonLayer.addGeoJSON(GeoJSONObject);
		};
		
		this.get = function() {
			return self.geojsonLayer;
		};

		this.parse = function(e) {
			self.name = e.properties[options.name];
		    var popupContent = self.name + "<Br>Loading ............";
		    if (e.properties && e.properties.popupContent) {
		        popupContent += e.properties.popupContent;
		    }
	      e.layer.setStyle({weight:1, fillColor:"blue"});
		};

		this.click = function(e) {
      e.layer.setStyle({fillColor:"green"})
      //$(".leaflet-popup-content").html(self.name);
      //$("#name").html(self.name + "<br>");
			console.log(self.name);
      //window.top.location.href = data_location + self.name;
			global_url = new MapUrl(data_location + self.name);
			$(document).ready(function() {
				$.getJSON(global_url.getUrl(), function(data) {				
					$('#community-school').html(data);
					console.log(data.total_no_of_community_schools);
				});
			});
		};

		this.set(options.geojsonObject);
	};

	var map = new NepalMap({mapcontrol_id: 'map', districts: districts});
	map.init();
</script>
